
<!doctype html>
<html lang="en">
    <head>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
        />
        <title>corol.io</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden;
                user-select: none;
                background: #000;
            }

            #canvas {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                cursor: default;
                touch-action: none;
            }

            #mobile-input {
                position: fixed;
                left: 0;
                top: 0;
                width: 0;
                height: 0;
                display: none;
                box-sizing: border-box;
                background: transparent;
                border: 0;
                padding: 0;
                margin: 0;
                color: #111;
                font-family: "Ubuntu", sans-serif;
                font-weight: 700;
                font-size: 16px;
                line-height: 1;
                outline: none;
                user-select: text;
                pointer-events: none;
                z-index: 5;
                -webkit-appearance: none;
                appearance: none;
            }
        </style>
    </head>
    <body>
        <canvas id="canvas"></canvas>
        <input
            id="mobile-input"
            type="text"
            enterkeyhint="send"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
        >
        <script type="module">
            const canvas = document.getElementById("canvas");
            const mobile_input = document.getElementById("mobile-input");
            globalThis.__corol_mobile_input = mobile_input;
            globalThis.__ctx = canvas.getContext("2d");
            globalThis.__ctxs = [globalThis.__ctx];

            async function LoadUbuntuFont(wasm_module) {
                if (!wasm_module || !wasm_module.memory) return;
                if (!wasm_module.GetUbuntuBoldFontPtr || !wasm_module.GetUbuntuBoldFontLength) return;
                const ptr = wasm_module.GetUbuntuBoldFontPtr();
                const len = wasm_module.GetUbuntuBoldFontLength();
                const source_bytes = new Uint8Array(wasm_module.memory.buffer, ptr, len);
                const font_bytes = new Uint8Array(len);
                font_bytes.set(source_bytes);
                const font_face = new FontFace("Ubuntu", font_bytes, { weight: "700" });
                await font_face.load();
                document.fonts.add(font_face);
            }

            const wasm = await import("/release.js");
            globalThis.__corol_wasm = wasm;
            globalThis.__liftString = wasm.__liftString;

            await LoadUbuntuFont(wasm);
            
            globalThis.__socket_on_raw_open = wasm.__socket_on_raw_open;
            globalThis.__socket_on_close = wasm.__socket_on_close;
            globalThis.__socket_on_raw_message = wasm.__socket_on_raw_message;
            globalThis.__socket_incoming_ptr = wasm.__socket_incoming_ptr;

            const {
                Init,
                Loop,
                Resize,
                MouseEvent,
                KeyEvent,
                TouchEvent,
                WheelEvent,
                BlurEvent,
                ClipboardEvent,
                ConnectToServer,
            } = wasm;
            canvas.oncontextmenu = () => false;
            let mobile_enter_down = false;

            function CorolMobileInputOnInput(event) {
                const target = event.target;
                const value = target && target.value ? target.value : "";
                const wasm = globalThis.__corol_wasm;
                if (!wasm || !wasm.MobileInputOnInput) return;
                wasm.MobileInputOnInput(value);
            }

            function CorolMobileInputOnBeforeInput(event) {
                if (mobile_enter_down) return;
                const input_type = event && event.inputType ? event.inputType : "";
                if (input_type !== "insertLineBreak" && input_type !== "insertParagraph") return;
                event.preventDefault();
                KeyEvent(13, 0);
                KeyEvent(13, 1);
            }

            function CorolMobileInputOnBlur(event) {
                CorolMobileInputOnInput(event);
                const wasm = globalThis.__corol_wasm;
                mobile_enter_down = false;
                if (!wasm || !wasm.MobileInputOnBlur) return;
                wasm.MobileInputOnBlur();
            }

            function CorolMobileInputOnKeyDown(event) {
                const is_enter = event.key === "Enter" || event.keyCode === 13;
                if (!is_enter || event.repeat) return;
                event.preventDefault();
                mobile_enter_down = true;
                KeyEvent(13, 0);
            }

            function CorolMobileInputOnKeyUp(event) {
                const is_enter = event.key === "Enter" || event.keyCode === 13;
                if (!is_enter) return;
                event.preventDefault();
                mobile_enter_down = false;
                KeyEvent(13, 1);
            }

            if (mobile_input) {
                mobile_input.addEventListener("input", CorolMobileInputOnInput);
                mobile_input.addEventListener("beforeinput", CorolMobileInputOnBeforeInput);
                mobile_input.addEventListener("change", CorolMobileInputOnInput);
                mobile_input.addEventListener("blur", CorolMobileInputOnBlur);
                mobile_input.addEventListener("keydown", CorolMobileInputOnKeyDown);
                mobile_input.addEventListener("keyup", CorolMobileInputOnKeyUp);
            }

            function TouchTargetsMobileInput(touch) {
                if (!mobile_input) return false;
                return touch.target === mobile_input;
            }

            function EventTouchesMobileInput(event) {
                if (!mobile_input) return false;
                if (event.touches) {
                    for (const t of event.touches) {
                        if (t.target === mobile_input) return true;
                    }
                }
                for (const t of event.changedTouches) {
                    if (t.target === mobile_input) return true;
                }
                return false;
            }

            window.addEventListener("keydown", (e) => {
                if ((e.ctrlKey || e.metaKey) && (e.key === "a" || e.key === "A" || e.keyCode === 65)) {
                    e.preventDefault();
                }
                if (!e.repeat) KeyEvent(e.keyCode, 0);
            });

            window.addEventListener("keyup", (e) => {
                if (!e.repeat) KeyEvent(e.keyCode, 1);
            });

            window.addEventListener("mousedown", (e) => {
                if (e.button !== 0 && e.button !== 2) return;
                MouseEvent(
                    e.clientX * devicePixelRatio,
                    e.clientY * devicePixelRatio,
                    0,
                    e.button === 0 ? 0 : 1,
                );
            });

            window.addEventListener("mousemove", (e) => {
                MouseEvent(
                    e.clientX * devicePixelRatio,
                    e.clientY * devicePixelRatio,
                    1,
                    0,
                );
            });

            window.addEventListener("mouseup", (e) => {
                if (e.button !== 0 && e.button !== 2) return;
                MouseEvent(
                    e.clientX * devicePixelRatio,
                    e.clientY * devicePixelRatio,
                    2,
                    e.button === 0 ? 0 : 1,
                );
            });

            window.addEventListener(
                "touchstart",
                (e) => {
                    for (const t of e.changedTouches) {
                        if (TouchTargetsMobileInput(t)) continue;
                        const touch_x = t.clientX * devicePixelRatio;
                        const touch_y = t.clientY * devicePixelRatio;
                        TouchEvent(
                            touch_x,
                            touch_y,
                            0,
                            t.identifier,
                        );
                        const wasm = globalThis.__corol_wasm;
                        let should_focus = false;
                        if (wasm && wasm.MobileInputTouchStart) {
                            should_focus = wasm.MobileInputTouchStart(touch_x, touch_y);
                        }
                        if (!should_focus && wasm && wasm.MobileChatButtonTouchStart) {
                            wasm.MobileChatButtonTouchStart(touch_x, touch_y);
                        }
                    }
                    if (!EventTouchesMobileInput(e)) e.preventDefault();
                },
                { passive: false },
            );

            window.addEventListener(
                "touchmove",
                (e) => {
                    if (!EventTouchesMobileInput(e)) e.preventDefault();
                    for (const t of e.changedTouches) {
                        if (TouchTargetsMobileInput(t)) continue;
                        TouchEvent(
                            t.clientX * devicePixelRatio,
                            t.clientY * devicePixelRatio,
                            1,
                            t.identifier,
                        );
                    }
                },
                { passive: false },
            );

            window.addEventListener(
                "touchend",
                (e) => {
                    for (const t of e.changedTouches) {
                        if (TouchTargetsMobileInput(t)) continue;
                        TouchEvent(
                            t.clientX * devicePixelRatio,
                            t.clientY * devicePixelRatio,
                            2,
                            t.identifier,
                        );
                    }
                    if (!EventTouchesMobileInput(e)) e.preventDefault();
                },
                { passive: false },
            );

            window.addEventListener(
                "touchcancel",
                (e) => {
                    if (!EventTouchesMobileInput(e)) e.preventDefault();
                    for (const t of e.changedTouches) {
                        if (TouchTargetsMobileInput(t)) continue;
                        TouchEvent(
                            t.clientX * devicePixelRatio,
                            t.clientY * devicePixelRatio,
                            2,
                            t.identifier,
                        );
                    }
                },
                { passive: false },
            );

            window.addEventListener("wheel", (e) => {
                WheelEvent(e.deltaY);
            });

            window.addEventListener("blur", () => {
                BlurEvent();
            });

            window.addEventListener(
                "paste",
                (e) => {
                    try {
                        const clip = e.clipboardData.getData("text/plain");
                        ClipboardEvent(clip);
                    } catch (err) {}
                },
                { capture: true },
            );

            function ResizeCanvas() {
                const dpr = devicePixelRatio;
                canvas.width = document.documentElement.clientWidth * dpr;
                canvas.height = document.documentElement.clientHeight * dpr;
                return { width: canvas.width, height: canvas.height, dpr };
            }

            const initial = ResizeCanvas();
            Init(initial.width, initial.height, initial.dpr);
            
            const ws_scheme = location.protocol === "https:" ? "wss" : "ws";
            const hostname = location.hostname;
            const ws_url =
                hostname === "localhost"
                    ? `${ws_scheme}://${hostname}:2053`
                    : "wss://us-east.corol.io:2053";
            console.log("Connecting to", ws_url);
            ConnectToServer(ws_url);

            window.addEventListener("resize", () => {
                const { width, height, dpr } = ResizeCanvas();
                Resize(width, height, dpr);
            });

            function MainLoop(time) {
                Loop(time);
                requestAnimationFrame(MainLoop);
            }

            requestAnimationFrame(MainLoop);
        </script>
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"cef35ba70a9c473c97e7dc0b6af6fd3c","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
